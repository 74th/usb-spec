# ディスクリプタ

## ディスクリプタの種類

| wValue | 名称          | 機能                                                                |
| ------ | ------------- | ------------------------------------------------------------------- |
| 1      | DEVICE        | デバイス。USB バージョンや、VID、PID、CONFIGURATION の数など。      |
| 2      | CONFIGURATION | 設定。INTERFACE のか数が定義される。                                |
| 3      | STRING        | 文字列                                                              |
| 4      | INTERFACE     | インターフェース。インターフェイスや、ENDPOINT のか数が定義される。 |
| 5      | ENDPOINT      | エンドポイント。番号や、転送方法が定義される。                      |
| 21     | HID           | HID                                                                 |
| 22     | HID Report    | HID リポート                                                        |

## 共通項目

この項目は必ず最初の 2 バイトがこの値になっています。

## DEVICE (bDescriptorType:1)

USB デバイスの定義です。USB ドライバがなくても表示される基本情報となります。

| フィールド         | 形式     | サイズ | 説明                                 | 例                   |
| ------------------ | -------- | ------ | ------------------------------------ | -------------------- |
| bLength            | 数値     | 1      | このディスクリプタのサイズ           | 構造体を sizeof する |
| bDescriptorType    | 定数     | 1      | ディスクリプタのタイプ               | 1(DEVICE)            |
| bcdUSB             | BCD      | 2      | USB 仕様のバージョン                 | 0x0110(USB1.1)       |
| bDeviceClass       | Class    | 1      | クラスコード                         | 0                    |
| bDeviceSubClass    | SubClass | 1      | サブクラスコード                     | 0                    |
| bDeviceProtocol    | Protocol | 2      | プロトコルコード                     | 0                    |
| bMaxPacketSize     | Number   | 1      | エンドポイントの最大パケットサイズ   | 64(大きい値)         |
| idVendor           | ID       | 2      | ベンダー ID                          | 0x0000               |
| idProduct          | ID       | 2      | プロダクト ID                        | 0x0001               |
| bcdDevice          | BCD      | 2      | このデバイスのバージョン番号         | 0x010(0.1.0)         |
| iManufacturer      | Index    | 1      | 製造元の STRING のインデックス       | 1                    |
| iProduct           | Index    | 1      | プロダクト名の STRING のインデックス | 2                    |
| iSerialNumber      | Index    | 1      | シリアル番号                         | 0                    |
| bNumConfigurations | 数値     | 1      | CONFIGURATION の数                   | 1                    |

クラスコード、サブクラスコード、プロトコルコードの部分は、インターフェイスで再度定義されるため、定義なしの 0 が使われます。

## CONFIGURATION (bDescriptorType:2)

| フィールド          | 形式   | サイズ | 説明                                                 | 例                     |
| ------------------- | ------ | ------ | ---------------------------------------------------- | ---------------------- |
| bLength             | 数値   | 1      | このディスクリプタのサイズ                           | 構造体を sizeof する   |
| bDescriptorType     | 定数   | 1      | ディスクリプタのタイプ                               | 2(CONFIGURATION)       |
| wTotalLength        | 数値   | 1      | 連なる複数のデスクリプタを返す場合、合わせたバイト数 | 構造体の sizeof を合計 |
| bNumInterfaces      | 数値   | 1      | インターフェースのの数                               | 2                      |
| bConfigurationValue | 数値   | 1      | SET CONFIGURATION で使う値                           | 1                      |
| iConfiguration      | Index  | 1      | この CONFIGURATION の STRING のインデックス          | 0(STRING なし)         |
| bmAttribute         | BitMap | 1      | 設定の特性の bit 値                                  | 0b10100000             |
| bMaxPower           | 数値   | 1      | 最大消費電力(値 1 につき 2mA)                        | 50(100mA)              |

### bmAttribute

| bit | 値                     | 内容   |
| --- | ---------------------- | ------ |
| 7   | 予約                   | 1 固定 |
| 6   | セルフパワー           |        |
| 6   | リモートウェークアップ |        |
| 4-0 | 予約                   | 0 固定 |

## INTERFACE (bDescriptorType:4)

| フィールド         | 形式     | サイズ | 説明                                    | 例                   |
| ------------------ | -------- | ------ | --------------------------------------- | -------------------- |
| bLength            | 数値     | 1      | このディスクリプタのサイズ              | 構造体を sizeof する |
| bDescriptorType    | 定数     | 1      | ディスクリプタのタイプ                  | 4(INTERFACE)         |
| bInterfaceNumber   | 数値     | 1      | インターフェイスの番号(0 スタート)      | 0                    |
| bAlternateSetting  | 数値     | 1      | 代替設定の番号                          | 0(未使用)            |
| bNumEndpoints      | 数値     | 1      | エンドポイントの数                      | 1                    |
| bInterfaceClass    | Class    | 1      | クラスコード                            | 0x03(HID)            |
| bInterfaceSubClass | SubClass | 1      | サブクラスコード                        | 0x01(Boot Interface) |
| bInterfaceProtocol | Protocol | 1      | プロトコルコード                        | 0x01(Keyboard)       |
| iInterface         | Index    | 1      | この INTERFACE の STRING のインデックス | 0(STRING なし)       |

## ENDPOINT (bDescriptorType:5)

ここでこのエンドポイントの転送方式や、エンドポイントのデータ送信の方向を設定します。

| フィールド       | 形式           | サイズ | 説明                               | 例                           |
| ---------------- | -------------- | ------ | ---------------------------------- | ---------------------------- |
| bLength          | 数値           | 1      | このディスクリプタのサイズ         | 構造体を sizeof する         |
| bDescriptorType  | 定数           | 1      | ディスクリプタのタイプ             | 4(INTERFACE)                 |
| bEndpointAddress | エンドポイント | 1      | エンドポイントアドレスと方向       | 0x0111(1.11)                 |
| bmAttribute      | Bitmap         | 1      | エンドポイントの属性               | 0b00000011(インタラプト転送) |
| wMaxPacketSize   | Bitmap         | 1      | エンドポイントの最大パケットサイズ | 64                           |
| bInterval        | Bitmap         | 1      | データ転送のポーリング間隔         | 10                           |

bmAttribute は採用するデータ転送の方式に従って設定します。仕様タイプ、同期タイプは、アイソクロナス転送の場合のみ設定し、その他の転送の場合は 0 とします。

### bmEndpointAddress

| bit | 値                             | 内容                                             |
| --- | ------------------------------ | ------------------------------------------------ |
| 7   | エンドポイントのデータ送信方向 | 0:IN(ホスト→デバイス)<br/>1:OUT(デバイス→ホスト) |
| 6-4 | 予約                           | 0 固定                                           |
| 3-0 | エンドポイント番号             | 0-15                                             |

### bmAttribute

| bit | 値                                   | 内容                                                                                                                                                         |
| --- | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 7-6 | 予約                                 | 0固定                                                                                                                                                        |
| 5-4 | 使用タイプ（アイソクロナス転送のみ） | 0b00:データエンドポイント<br/>0b01:フィードバックエンドポイント<br/>0b10:インプリシットフィードバックデータエンドポイント<br/>アイソクロナス転送以外では0b00 |
| 3-2 | 同期タイプ（アイソクロナス転送のみ） | 0b00:同期無し<br/>0b01:非同期<br/>0b10:Adaptive<br/>0b11:同期<br/>アイソクロナス転送以外では0b00                                                             |
| 0-1 | 転送タイプ                           | 0b00:コントロール転送<br/>0b01:アイソクロナス転送<br/>0b10:バルク転送<br/>0b11:インタラプト転送                                                              |

## HID (bDescriptorType:21)

| フィールド      | 形式        | サイズ | 説明                       | 例                   |
| --------------- | ----------- | ------ | -------------------------- | -------------------- |
| bLength         | 数値        | 1      | このディスクリプタのサイズ | 構造体を sizeof する |
| bDescriptorType | 定数        | 1      | ディスクリプタのタイプ     | 21(HID)              |
| bcdHID          | BCD         | 1      | HID 仕様のバージョン       | 0x0111(1.11)         |
| bCountryCode    | CountryCode | 1      | 国コード                   | 0(未定義)            |
| bNumDescriptors | 数値        | 2      | HID の子ディスクリプタの数 | 1                    |

この末尾に、bNumberDescriptorsの数だけ以下が繰り返される。

| フィールド        | 形式           | サイズ | 説明                   | 例               |
| ----------------- | -------------- | ------ | ---------------------- | ---------------- |
| bDescriptorType   | DescriptorType | 1      | ディスクリプタのタイプ | 0x22(HID Report) |
| bDescriptorLength | 数値           | 2      | ディスクリプタの長さ   | 65               |

HID にキーボードは定義されているため、特にここで記述することは少ないです。

### bCountryCode

| 値   | 内容   |
| ---- | ------ |
| 0x00 | 未定義 |
| 0x15 | 日本   |
| 0x33 | US     |
